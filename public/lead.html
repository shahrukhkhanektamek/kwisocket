<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Socket.IO Test Client</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body:before {
      position: fixed;
      width: 100%;
      height: 100%;
      background: lightgray;
      top: 0;
      left: 0;
      content: "Wait...";
      color: black;
      font-size: 30px;
      text-align: center;
      align-items: center;
      display: grid;
    }
  </style>
</head>
<body>
  <h2>Socket.IO Test Client</h2>
  <div id="log"></div>

  <script>
    // üß© Get JSON data from ?data=...
    const params = new URLSearchParams(window.location.search);
    const rawData = params.get("data");
    let employee_leads = [];

    try {
      if (rawData) {
        employee_leads = JSON.parse(decodeURIComponent(rawData));
      } else {
        alert("‚ùå No data found in URL. Please pass ?data=...");
      }
    } catch (err) {
      console.error("Invalid data format:", err);
      alert("‚ùå Invalid JSON format in ?data param.");
    }

    if (employee_leads.length > 0) {
      const serverUrl = "http://145.223.18.56:3003";
      const socket = io(serverUrl);
      const log = document.getElementById("log");

      socket.on("connect", () => {
        log.innerHTML += `<p>‚úÖ Connected to server (${socket.id})</p>`;
        sendAllLeads();
      });

      socket.on("connect_error", (err) => {
        log.innerHTML += `<p style="color:red;">‚ùå Connection Error: ${err.message}</p>`;
      });

      // Function to send single record
      async function sendRequest(item) {
        try {
          log.innerHTML += `<p>üì§ Sending data for <b>${item.name}</b>...</p>`;

          const res = await fetch(`${serverUrl}/send-request`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
          });

          const result = await res.json();
          log.innerHTML += `<p style="color:green;">‚úÖ Request sent for ${item.name}: ${JSON.stringify(result)}</p>`;
        } catch (err) {
          log.innerHTML += `<p style="color:red;">‚ùå Error sending ${item.name}: ${err.message}</p>`;
        }
      }

      // Function to loop all data and send one by one
      async function sendAllLeads() {
        for (const lead of employee_leads) {
          if (!lead.device_id) continue;

          // Join socket room for this device
          socket.emit("joinDevice", lead.device_id);

          // Send data to API
          await sendRequest(lead);

          // Small delay (2 seconds)
          await new Promise(r => setTimeout(r, 2000));
        }

        log.innerHTML += `<p style="color:blue;">üéâ All requests sent successfully!</p>`;

        // Redirect after all done
        window.location.href = "https://knowledgewaveindia.com/payment-success?paymentSourse=webinar";
      }
    }
  </script>
</body>
</html>
