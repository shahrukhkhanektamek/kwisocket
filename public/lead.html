<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Socket.IO Test Client</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body:before {
      position: fixed;
      width: 100%;
      height: 100%;
      background: lightgray;
      top: 0;
      left: 0;
      content: "Wait...";
      color: black;
      font-size: 30px;
      text-align: center;
      align-items: center;
      display: grid ;
    }
  </style>
</head>
<body>
  <h2>Socket.IO Test Client</h2>
  <div id="log"></div>

  <script>
    // Get JSON data from URL ?data=...
    const params = new URLSearchParams(window.location.search);
    const rawData = params.get("data");
    let leadsArray = [];

    try {
      if (rawData) {
        leadsArray = JSON.parse(decodeURIComponent(rawData));
      } else {
        alert("‚ùå No data provided in URL.");
      }
    } catch (err) {
      console.error("Invalid data format:", err);
      alert("‚ùå Invalid JSON format.");
    }

    // const serverUrl = "http://localhost:3003";
    const serverUrl = "http://145.223.18.56:3003";
    const socket = io(serverUrl);
    const log = document.getElementById("log");

    // Send single lead
    async function sendLead(lead) {

      if(lead.device_id)
      {
        try {
          log.innerHTML += `<p>üì§ Sending data for <b>${lead.name}</b>...</p>`;

          // Only emit joinDevice if device_id exists
          if (lead.device_id) {
            socket.emit("joinDevice", lead.device_id);
          }

          // Add deviceId property for API
          lead.deviceId = lead.device_id;
          console.log(lead)

          const res = await fetch(`${serverUrl}/send-request`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(lead)
          });

          const result = await res.json();
          log.innerHTML += `<p style="color:green;">‚úÖ Request sent for ${lead.name}: ${JSON.stringify(result)}</p>`;
        } catch (err) {
          log.innerHTML += `<p style="color:red;">‚ùå Error sending ${lead.name}: ${err.message}</p>`;
        }
      }
    }

    // Loop through all leads sequentially
    async function sendAllLeads() {
      for (const lead of leadsArray) {
        await sendLead(lead);
        // Optional delay between requests
        await new Promise(r => setTimeout(r, 2000));
      }
      log.innerHTML += `<p style="color:blue;">üéâ All requests sent successfully!</p>`;
    }

    // Start sending when socket connected
    socket.on("connect", () => {
      log.innerHTML += `<p>‚úÖ Connected (${socket.id})</p>`;
      sendAllLeads();
    });

    socket.on("connect_error", (err) => {
      log.innerHTML += `<p style="color:red;">‚ùå Connection error: ${err.message}</p>`;
    });

    // Optional: listen for incoming messages per device
    leadsArray.forEach(lead => {
      if (lead.device_id) {
        socket.on(lead.device_id, (data) => {
          log.innerHTML += `<p style="color:green;">Incoming Data for ${lead.name}: ${JSON.stringify(data)}</p>`;
        });
      }
    });
  </script>
</body>
</html>
